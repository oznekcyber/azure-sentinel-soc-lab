// Malware Indicators Detection
// Detects known malicious IPs, domains, and file hashes
// MITRE ATT&CK: T1071 - Application Layer Protocol
// MITRE ATT&CK: T1204 - User Execution
// Severity: High
// Frequency: Run every 5 minutes
//
// PREREQUISITE: Create a watchlist named 'MaliciousIPs' with a column 'SearchKey' 
// containing known malicious IP addresses before using this query.
// To create the watchlist:
// 1. Go to Azure Sentinel -> Watchlist -> Add New
// 2. Name: MaliciousIPs
// 3. SearchKey: IPAddress column
// 4. Upload CSV with malicious IPs

// Detection 1: Known Malicious IPs from Threat Intelligence
// Note: This query requires the 'MaliciousIPs' watchlist to exist
let MaliciousIPs = _GetWatchlist('MaliciousIPs')
| project IPAddress = SearchKey;

SecurityEvent
| where TimeGenerated > ago(1h)
| where EventID in (4624, 4625)  // Login events
| where IpAddress != "-" and IpAddress != ""
| join kind=inner MaliciousIPs on $left.IpAddress == $right.IPAddress
| project 
    TimeGenerated,
    Computer,
    EventType = case(EventID == 4624, "Successful Login", "Failed Login"),
    Account = TargetUserName,
    MaliciousIP = IpAddress,
    LogonType,
    AlertType = "Known Malicious IP"

// UNION with DNS queries to malicious domains (if DNS logs available)
| union (
    DnsEvents
    | where TimeGenerated > ago(1h)
    | where Name has_any (
        // Known malicious domains - examples
        ".onion.",
        "malware.",
        "c2server.",
        "evil.",
        // Add your threat intel domains here
        ".top",  // Often used by malware
        ".xyz"   // Often used by malware
    )
    | project 
        TimeGenerated,
        Computer = ClientIP,
        EventType = "DNS Query",
        Account = "",
        MaliciousIP = Name,
        LogonType = "",
        AlertType = "Suspicious DNS Query"
)

// UNION with connections to known bad ports
| union (
    SecurityEvent
    | where TimeGenerated > ago(1h)
    | where EventID == 5156  // Windows Filtering Platform allowed connection
    | where DestPort in (
        4444,   // Metasploit default
        5555,   // Common backdoor
        1234,   // Common backdoor
        6666,   // Common backdoor
        31337,  // Elite backdoor
        8080,   // Alternative HTTP (suspicious if internal)
        8443,   // Alternative HTTPS (suspicious if internal)
        9001,   // Tor default
        9050,   // Tor SOCKS
        9051    // Tor control
    )
    | project 
        TimeGenerated,
        Computer,
        EventType = "Suspicious Port Connection",
        Account = "",
        MaliciousIP = strcat(DestAddress, ":", DestPort),
        LogonType = "",
        AlertType = "Known Malicious Port"
)

// UNION with file hash matches (if available)
| union (
    DeviceFileEvents
    | where TimeGenerated > ago(1h)
    | where SHA256 in (
        // Add known malicious file hashes from threat intel
        "example_malicious_hash_1",
        "example_malicious_hash_2"
    )
    | project 
        TimeGenerated,
        Computer = DeviceName,
        EventType = "Malicious File Detected",
        Account = InitiatingProcessAccountName,
        MaliciousIP = FileName,
        LogonType = SHA256,
        AlertType = "Known Malicious File Hash"
)
| order by TimeGenerated desc


// Alternative: Check against geo-enriched threat intelligence
// Detects connections to high-risk countries (customize as needed)
| union (
    SecurityEvent
    | where TimeGenerated > ago(1h)
    | where EventID == 4624
    | where LogonType == 10  // RDP
    | where IpAddress != "-"
    | extend GeoInfo = geo_info_from_ip_address(IpAddress)
    | extend Country = tostring(GeoInfo.country)
    // Flag connections from countries with no expected business relationships
    | where Country in ("", "Unknown")  // Unknown geo is suspicious
    | project 
        TimeGenerated,
        Computer,
        EventType = "Login from Unknown Location",
        Account = TargetUserName,
        MaliciousIP = IpAddress,
        LogonType = tostring(LogonType),
        AlertType = "Suspicious Geolocation"
)
| order by TimeGenerated desc
